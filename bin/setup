#!/bin/sh
get_env() {
  heroku config --app carnival-staging |\
    sed '/^\(HALCYON_\(AWS_\|S3_\).*\): *\(.*\)/!d; s//export \1=\3/g'

  cat <<EOF

# Update these variables from https://upcase.com/oauth/applications
export LEARN_OAUTH_CLIENT_ID=x
export LEARN_OAUTH_CLIENT_SECRET=x
EOF
}

if ! command -v heroku >/dev/null; then
  echo "The \`heroku' command is required to run this setup." >&2
  echo "https://toolbelt.heroku.com/" >&2
  exit 1
fi

if [ ! -w /app ]; then
  echo 'Using sudo to create a user-writable /app directory for building'
  sudo mkdir -p /app
  sudo chown $USER:$USER /app
fi

heroku join --app carnival-staging || true
heroku join --app carnival-production || true

if [ ! -f ./.env ]; then
  echo 'Creating ./.env...'
  get_env > ./.env
fi

./bin/setup-db
./bin/halcyon-build

echo 'Setup complete'
